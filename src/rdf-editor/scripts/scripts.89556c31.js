"use strict";angular.module("myApp",["ngRoute","angularSpinner","myApp.welcome","myApp.editor","myApp.fileBrowser"]).config(["$routeProvider",function(a){a.otherwise({redirectTo:"/welcome"})}]).factory("Notification",function(){function a(a,b,c){var d={message:b};"error"===a&&(a="danger"),c||"danger"!==a||(c="fire"),c&&(d.icon="glyphicon glyphicon-"+c),$.growl(d,{type:a})}return $.growl(!1,{placement:{from:"top",align:"center"},z_index:1050,template:'<div data-growl="container" class="alert" role="alert">       <button type="button" class="close" data-growl="dismiss">         <span aria-hidden="true">Ã—</span>         <span class="sr-only">Close</span>       </button>       <span data-growl="icon"></span>       <span data-growl="title"></span>       &nbsp;<span data-growl="message"></span>&nbsp;     </div>'}),{notify:a}}).factory("Profile",["$q",function(a){var b=new VAL;return b.getProfile=function(){var b=this;return b.profileData?a.when(b):(b.promise||(b.promise=a(function(a,c){b.profile(function(d,e){d?a(b):c(b)})})),b.promise)},b}]).controller("AuthInfoDialogCtrl",["$scope","$modalInstance","url",function(a,b,c){a.username="",a.password="",a.url=c,a.ok=function(){b.close({username:a.username,password:a.password})},a.cancel=function(){b.dismiss()}}]).factory("DocumentTree",["$q","$modal","usSpinnerService","Profile","RDFEConfig",function(a,b,c,d,e){function f(d,e){var f=l[d];return f||"/"===d[d.length-1]||(f=l[d.substring(0,d.lastIndexOf("/")+1)]),e===!1||e!==!0&&f?a.when(f):a(function(a,e){c.stop("editor-spinner"),b.open({templateUrl:"tmpl/authinfodlg.html",controller:"AuthInfoDialogCtrl",resolve:{url:function(){return d}}}).result.then(function(b){l[d]=b,a(b)},e)})}function g(){var a=new RDFE.IO.Folder;return a.name=a.path="Recent Documents",a.ioType="recent",a.comment="Documents you recently opened",a.children=h(),a}function h(){var a=[],b=$.jStorage.get("rdfe:recentDocuments");if(b)for(var c=0;c<b.length&&10>c;c++){var d=b[c];if(d){var e=new RDFE.IO.File(d.url);e.ioType=d.ioType,e.name=d.title||e.name,e.sparqlEndpoint=d.sparqlEndpoint,a.push(e)}}return a}function i(){if(k.length)return a.when(k);var b;return k=[g()],a(function(a,c){e.getConfig().then(function(a){return b=a.options.storage||[],d.getProfile()}).then(function(c){for(var d=c.profileData.storage||[],e=0;e<d.length;e++)_.isEmpty(_.where(b,{uri:d[e].uri}))&&(b=b.concat(d[e]));b.length?RDFE.Utils.resolveStorageLocations(b,function(b){$.merge(k,b),a(k)}):a(k)},function(){a(k)})})}function j(a,b){var c,d=!0,e=$.jStorage.get("rdfe:recentDocuments");e||(e=[]);for(var f=0;f<e.length;f++)if(c=e[f],c.url===a&&c.ioType===b){d=!1,e.splice(f,1),e.unshift(c);break}d&&(c=new RDFE.IO.File(a),c.ioType=b,e.unshift(c),e.length>10&&e.splice(e.length-1,1)),$.jStorage.set("rdfe:recentDocuments",e)}var k=[],l={};return{getLocations:i,getAuthInfo:f,getRecentDocs:h,addRecentDoc:j}}]).factory("RDFEConfig",["$q","Notification",function(a,b){function c(){return d?a.when(d):a(function(a,c){var e=RDFE.Utils.uriParams(),f=e.config?e.config:"config.json";d=new RDFE.Config(f,function(b){a(b)},function(){b.notify("error","Failed to load Editor configuration")})})}var d=null;return{getConfig:c}}]).controller("AuthHeaderCtrl",["$rootScope","$scope","$window","Profile",function(a,b,c,d){function e(a){b.userProfile=a,b.profile=a.profileData}function f(){if(a.editor&&a.editor.doc&&a.editor.doc.dirty){var b=a.editor.doc;b.store.graph(b.graph,function(a,b){if(a){var c=b.toNT();$.jStorage.set("rdfe:savedDocument",c)}})}}b.login=function(a){b.userProfile.config.valInstalled&&(f(),c.location=b.userProfile.config.host+b.userProfile.config.loginLink+"?returnto="+encodeURIComponent(window.location.href))},b.logout=function(a){b.userProfile.config.valInstalled&&(f(),c.location=b.userProfile.config.host+b.userProfile.config.logoutLink+"?returnto="+encodeURIComponent(window.location.href))},d.getProfile().then(e,e)}]),angular.module("myApp.welcome",["ngRoute"]).config(["$routeProvider",function(a){a.when("/welcome",{templateUrl:"views/welcome.html",controller:"WelcomeCtrl"})}]).controller("WelcomeCtrl",[function(){}]),angular.module("myApp.editor",["ngRoute"]).config(["$routeProvider",function(a){a.when("/editor",{templateUrl:"views/editor.html",controller:"EditorCtrl"})}]).factory("RDFEditor",["$q","usSpinnerService","RDFEConfig","Notification","DocumentTree",function(a,b,c,d,e){function f(){return g?a.when(g):a(function(a,f){c.getConfig().then(function(c){g=new RDFE.Editor(c,e),$(g).on("rdf-editor-success",function(a,b){d.notify("success",b.message)}).on("rdf-editor-error",function(a,b){d.notify("error",b.message)}).on("rdf-editor-start",function(a,c){b.spin("editor-spinner")}).on("rdf-editor-done",function(a,c){b.stop("editor-spinner")}),a(g)})})}var g=null;return{getEditor:f}}]).filter("namingSchemaLabel",function(){return function(a,b,c,d){if(b.namingSchema){var e=c===!0?1:0;return b.namingSchema[a][e]}}}).filter("viewModeKey",function(){return function(a){switch(a){case"triples":return"spo";case"predicates":return"p";case"entities":return"s";case"values":return"o";default:return a}}}).controller("EditorCtrl",["$rootScope","$scope","$routeParams","$location","$timeout","usSpinnerService","RDFEditor","DocumentTree","Notification",function(a,b,c,d,e,f,g,h,i){function j(a){a?f.spin("editor-spinner"):f.stop("editor-spinner")}function k(a,b,c){var d;h.getAuthInfo&&(d=function(a,b,c){h.getAuthInfo(a,!0).then(b,c)});var e=RDFE.IO.createIO(a,{sparqlEndpoint:b,gspEndpoint:$("#gspEndpoint").val(),ioTimeout:c});return e.type=a,e.options.authFunction=d,e}function l(a,c,d,e){var f;try{f=k(c||"sparql",d,e);var g=function(a,c){j(!0),b.mainDoc.load(a,c,function(){m(),b.editor.updateView(),b.$apply(function(){b.mainDoc.url=a}),n(),b.editor.docChanged()},function(a){var b=a&&a.message?a.message:"Failed to load document";i.notify("error",b),j(!1)})};h.getAuthInfo?h.getAuthInfo(a,!1).then(function(b){b&&(f.options.username=b.username,f.options.password=b.password),g(a,f)}):g(a,f)}catch(l){return void i.notify("error",l)}}function m(){var a=c["statement:subject"],d=c["statement:predicate"],e=c["statement:object"];a?b.viewMode="statements"===c.view?"triples":"entities":d?b.viewMode="statements"===c.view?"triples":"predicates":e?b.viewMode="statements"===c.view?"triples":"values":(a||d||e)&&(b.viewMode="triples"),b.editor.toggleView(b.viewMode)}function n(){var a=c.newStatement,d=c["statement:subject"],e=c["statement:predicate"],f=c["statement:object"],g=c.view;!d||g&&"entities"!==g?!e||g&&"predicates"!==g?!f||g&&"values"!==g?!(d||e||f||a)||g&&"statements"!==g||b.editor.editTriple(d,e,f,a):b.editor.editObject(f,a):b.editor.editPredicate(e,a):b.editor.editSubject(d,a)}function o(a,c,d){c||(c=b.mainDoc.url),d||(d=b.mainDoc.io);var e=function(e,f,g){if("success"===f){if((!b.mainDoc.url||b.mainDoc.io&&b.mainDoc.io!==d)&&e.length)return void bootbox.confirm("Target document exists. Do you really want to overwrite it?",function(b){b&&a(c,d)});if(b.mainDoc.srcParams&&(b.mainDoc.srcParams.length!==e.length||b.mainDoc.srcParams.md5!==$.md5(e)))return void bootbox.confirm("Target document was updated after last open/save. Do you really want to overwrite it?",function(b){b&&a(c,d)})}a(c,d)};d.retrieve(c,{success:e,error:e})}g.getEditor().then(function(d){if(a.editor=d,b.editor=d,b.namingSchema=d.config.options[d.config.options.namingSchema],b.mainDoc=b.editor.doc,b.ontologyManager=b.editor.ontologyManager,b.editor.render($("#contents")),c.saveDocument)b.mainDoc.url=c.uri,b.mainDoc.io=k(c.ioType,c.sparqlEndpoint,d.config.options.ioTimeout),b.saveDocument(),b.editor.updateView();else if(c.newDocument)b.mainDoc["new"](function(){m(),b.editor.updateView(),e(function(){c.uri&&(b.mainDoc.url=c.uri,b.mainDoc.io=k(c.ioType,c.sparqlEndpoint,d.config.options.ioTimeout))}),n()},function(){i.notity("error","Failed to clear Document for unknown reasons.")});else if(c.uri){var f=$.jStorage.get("rdfe:savedDocument",null);f?b.mainDoc.store.clear(function(){b.mainDoc.store.loadTurtle(f,b.mainDoc.graph,b.mainDoc.graph,function(a,f){a&&(m(),b.editor.updateView(),e(function(){b.mainDoc.dirty=!0,b.mainDoc.url=c.uri,b.mainDoc.io=k(c.ioType,c.sparqlEndpoint,d.config.options.ioTimeout)}),n())})}):l(c.uri,c.ioType,c.sparqlEndpoint,d.config.options.ioTimeout)}$.jStorage.deleteKey("rdfe:savedDocument"),b.viewMode=b.editor.currentView(),b.$watch(function(a){return a.viewMode},function(a){b.editor.toggleView(a)}),b.ontologyView=new RDFE.OntologyView(b.ontologyManager),b.ontologyView.render($("#container-ontologies")),$("#ontology-add").click(function(a){a.stopPropagation(),b.ontologyView.editor()})}),b.saveDocument=function(){if(b.mainDoc.url){var a=function(){j(!0),b.mainDoc.save(function(){j(!1),i.notify("success","Successfully saved document to <code>"+b.mainDoc.url+"</code>")},function(a){j(!1),i.notify("error",a?a.message||a:"An unknown error occured")})};o(a)}else b.saveDocumentAs()},b.saveDocumentAs=function(){d.url("/browser?mode=save")},b.downloadDocumentAs=function(){function a(a,b){var c=document.createElement("a");if(c.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(b)),c.setAttribute("download",a),document.createEvent){var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),c.dispatchEvent(d)}else c.click()}b.mainDoc.store.graph(b.mainDoc.graph,function(b,c){var d=c.toNT();a("document.ttl",d)})},b.openDocument=function(){function a(){d.url("/browser")}b.mainDoc.dirty?bootbox.confirm("Your document has unsaved changes. Do you really want to open another document?",function(c){c&&b.$apply(a)}):a()},b.closeDocument=function(){function a(){d.url("/")}b.mainDoc.dirty?bootbox.confirm("Your document has unsaved changes. Do you really want to close the document?",function(c){c&&b.$apply(a)}):a()},b.toggleOntologyView=function(){var a=$("#panel-ontologies").find(".panel-heading");a.find(".up").toggle(),a.find(".down").toggle(),$("#container-ontologies").toggle(),$("#ontology-add").toggle()}}]),angular.module("myApp.fileBrowser",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/browser",{templateUrl:"views/browser.html",controller:"FileBrowserCtrl"})}]).filter("ioTypeLabel",function(){return function(a){switch(a){case"webdav":return"WebDAV Folder";case"ldp":return"LDP Location";case"sparql":return"SPARQL Endpoint";default:return a}}}).filter("httpStatusLabel",function(){return function(a){switch(a){case 0:return"Connection Refused";case 404:return"Not Found";case 401:return"Authorization Required";case 403:return"Access Denied";default:return a}}}).controller("FileBrowserCtrl",["$rootScope","$scope","$routeParams","$timeout","$location","usSpinnerService","DocumentTree","Notification",function(a,b,c,d,e,f,g,h){"save"===c.mode?(b.mode=c.mode,b.title="Save Your Document"):(b.mode="open",b.title="Open a Document"),b.locations=[],g.getLocations().then(function(c){b.locations=c;var d=0;if(a.currentLocation)for(var e=0;e<b.locations.length;e++)if(b.locations[e].url===a.currentLocation.url){d=e;break}b.updateCurrentLocation(b.locations[d]),b.updateCurrentFolder(b.currentLocation),f.stop("location-spinner")}),b.setCurrentLocation=function(a){if(b.resetUI(),a!=b.currentLocation)if(a.httpStatus){var c;g.getAuthInfo&&(c=function(a,b,c){g.getAuthInfo(a,!0).then(b,c)}),RDFE.IO.openUrl(a.url,{authFunction:c,checkForFiles:!0},function(c){b.$apply(function(){b.locations[b.locations.indexOf(a)]=c,b.updateCurrentLocation(c),b.updateCurrentFolder(c)})},function(c,e){a.httpStatus=e,a.errorMessage=c,d(function(){b.updateCurrentLocation(a),b.updateCurrentFolder(a)})})}else b.updateCurrentLocation(a),b.updateCurrentFolder(a)},b.updateCurrentLocation=function(c){b.currentLocation=c,a.currentLocation=c,b.orderProp="Recent Documents"===c.name?null:"name"},b.updateCurrentFolder=function(a){b.currentFolder=a,b.currentFolder&&b.currentFolder.dirty&&b.refresh()},b.changeDir=function(a){var c=function(){f.stop("refresh-spinner"),b.currentFolder=a};b.resetUI(),f.spin("refresh-spinner"),a.dirty?(a.httpStatus=null,a.errorMessage=null,a.update(function(){b.$apply(function(){c()})},function(a,d,e){a.httpStatus=e,a.errorMessage=d,b.$apply(function(){c()})})):c()},b.folderUp=function(){b.currentFolder.parent&&(b.updateCurrentFolder(b.currentFolder.parent),b.resetUI())},b.refresh=function(){b.resetUI(),"Recent Documents"===b.currentLocation.name?(b.currentLocation.children=g.getRecentDocs(),b.currentFolder=b.currentFolder):(f.spin("refresh-spinner"),b.currentFolder.httpStatus=null,b.currentFolder.errorMessage=null,b.currentFolder.update(!0,function(){b.$evalAsync(function(){b.currentFolder=b.currentFolder,d(function(){f.stop("refresh-spinner")},1e3)})},function(a,c,d){f.stop("refresh-spinner"),a.httpStatus=d,a.errorMessage=c,b.$apply()}))},b.openFile=function(a){var c="/editor?uri="+encodeURIComponent(a.url)+"&ioType="+encodeURIComponent(a.ioType);a.sparqlEndpoint&&(c+="&sparqlEndpoint="+encodeURIComponent(a.sparqlEndpoint)),"save"===b.mode?c+="&saveDocument=true":a.isNew&&(c+="&newDocument=true"),e.url(c)},b.open=function(a){"file"===a.type?b.openFile(a):b.changeDir(a)},b.addLocation=function(a){for(var c=0;c<b.locations.length;c++)if(b.locations[c].url===a.url)return void(b.locations[c]=a);b.locations.push(a)},b.removeLocation=function(a){for(var c=0;c<b.locations.length;c++)if(b.locations[c].url===a.url)return b.locations.splice(c,1),void(a===b.currentLocation&&b.setCurrentLocation(b.locations[0]))},b.addingLocation=!1,b.showNewLocationUi=function(){b.addingLocation=!0,b.newLocationUrl=""},b.addNewLocation=function(){if(b.newLocationUrl&&b.newLocationUrl.length)if(b.newLocationIsSparql){var a=new RDFE.IO.Folder(b.newLocationUrl);a.ioType="sparql",a.sparqlEndpoint=b.newLocationUrl,b.addLocation(a),b.updateCurrentLocation(a),b.currentFolder=a,b.addingLocation=!1}else{f.spin("location-spinner");var c;g.getAuthInfo&&(c=function(a,b,c){g.getAuthInfo(a,!0).then(b,c)}),RDFE.IO.openUrl(b.newLocationUrl,{authFunction:c,checkForFiles:!0},function(a){b.$apply(function(){b.addingLocation=!1,b.addLocation(a),b.updateCurrentLocation(a),b.currentFolder=a}),f.stop("location-spinner")},function(a,b){h.notify("error",a),f.stop("location-spinner")})}},b.addingGraph=!1,b.showNewGraphUi=function(){b.addingGraph=!0,b.newGraphUri=""},b.addNewGraph=function(){if(b.newGraphUri&&b.newGraphUri.length){var a=new RDFE.IO.File(b.newGraphUri);a.parent=b.currentFolder,a.sparqlEndpoint=b.currentFolder.sparqlEndpoint,a.ioType="sparql",b.currentFolder.children.push(a),b.openFile(gr)}},b.addingFile=!1,b.newFileName="myDocument.ttl",b.showNewFileUi=function(){b.addingFile=!0,b.newFileName="myDocument.ttl"},b.addNewFile=function(){if(b.newFileName&&b.newFileName.length){b.currentFolder.dirty=!0;var a=b.currentFolder.url+b.newFileName,c=new RDFE.IO.File(a);c.isNew=!0,c.ioType=b.currentFolder.ioType,b.openFile(c)}},b.resetUI=function(){b.addingFile=!1,b.addingGraph=!1,b.addingLocation=!1}}]);